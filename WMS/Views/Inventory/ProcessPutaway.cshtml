@model WMS.Models.ViewModels.PutawayViewModel
@{
    ViewData["Title"] = "Process Putaway";
}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">
                <i class="fas fa-truck-loading me-2"></i>
                Process Putaway
            </h1>
            <p class="page-subtitle">Put items from ASN @Model.ASNNumber into warehouse locations</p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("Putaway", "Inventory")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Putaway
            </a>
        </div>
    </div>
</div>

<!-- ASN Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ASN Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label fw-bold">ASN Number</label>
                            <p class="form-control-plaintext">@Model.ASNNumber</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label fw-bold">PO Number</label>
                            <p class="form-control-plaintext">@Model.PONumber</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Supplier</label>
                            <p class="form-control-plaintext">@Model.SupplierName</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Shipment Date</label>
                            <p class="form-control-plaintext">@Model.ShipmentDate.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Items to Putaway Section -->
@{ 
    var itemsToPutaway = Model.PutawayDetails.Where(d => !d.IsCompleted).ToList();
    var completedItems = Model.PutawayDetails.Where(d => d.IsCompleted).ToList();
}

@if (itemsToPutaway.Any())
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes me-2"></i>
                        Items to Putaway (@itemsToPutaway.Count items)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <form id="putawayForm" method="post">
                        @Html.AntiForgeryToken()
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th class="text-center">Unit</th>
                                        <th class="text-center">Total Qty</th>
                                        <th class="text-center">Put Away</th>
                                        <th class="text-center">Remaining</th>
                                        <th class="text-center">Price/Unit</th>
                                        <th class="text-center">Putaway Qty</th>
                                        <th class="text-center">Location</th>
                                        <th class="text-center">Actions</th>
                                        <th class="text-center">Progress</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < itemsToPutaway.Count; i++)
                                    {
                                        var detail = itemsToPutaway[i];
                                        var formIndex = i;
                                        <tr>
                                            <td>
                                                <div>
                                                    <strong>@detail.ItemCode</strong>
                                                    <br><small class="text-muted">@detail.ItemName</small>
                                                </div>
                                            </td>
                                            <td class="text-center">@detail.ItemUnit</td>
                                            <td class="text-center">
                                                <span class="badge bg-info">@detail.TotalQuantity</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-success">@detail.AlreadyPutAwayQuantity</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-warning">@detail.RemainingQuantity</span>
                                            </td>
                                            <td class="text-center">
                                                <strong>@detail.ActualPricePerItem.ToString("C")</strong>
                                            </td>
                                            <td class="text-center">
                                                <input type="hidden" name="PutawayDetails[@formIndex].ASNDetailId" value="@detail.ASNDetailId" />
                                                <input type="hidden" name="PutawayDetails[@formIndex].ItemId" value="@detail.ItemId" />
                                                <input type="number" 
                                                       name="PutawayDetails[@formIndex].QuantityToPutaway" 
                                                       class="form-control form-control-sm text-center" 
                                                       min="1" 
                                                       max="@detail.RemainingQuantity" 
                                                       value="@detail.RemainingQuantity"
                                                       data-item-id="@detail.ItemId"
                                                       data-detail-index="@detail.ASNDetailId"
                                                       style="width: 80px;" />
                                            </td>
                                            <td class="text-center">
                                                <select name="PutawayDetails[@formIndex].LocationId" 
                                                        class="form-select form-select-sm location-select" 
                                                        style="width: 200px;" 
                                                        data-quantity="@detail.QuantityToPutaway"
                                                        data-index="@formIndex"
                                                        onchange="validateLocationCapacity(this, @detail.QuantityToPutaway)">
                                                    <option value="">-- Select Location --</option>
                                                    @foreach (var location in Model.LocationDropdownItems)
                                                    {
                                                        <option value="@location.Id" 
                                                                class="@location.CssClass"
                                                                data-available="@location.AvailableCapacity"
                                                                data-max="@location.MaxCapacity"
                                                                data-current="@location.CurrentCapacity"
                                                                data-status="@location.StatusText"
                                                                selected="@(location.Id == detail.SuggestedLocationId)">
                                                            @location.DisplayText - @location.StatusText (@location.CurrentCapacity/@location.MaxCapacity)
                                                        </option>
                                                    }
                                                </select>
                                                <div class="location-warning mt-1" id="warning-@formIndex" style="display: none;">
                                                    <small class="text-danger">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                        <span class="warning-text"></span>
                                                    </small>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-primary btn-sm process-putaway-btn" 
                                                            data-index="@formIndex"
                                                            data-asn-detail-id="@detail.ASNDetailId"
                                                            onclick="processSingleItem(@formIndex, @detail.ASNDetailId)">
                                                        <i class="fas fa-play"></i> Process
                                                    </button>
                                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                                            onclick="suggestLocation(@formIndex)">
                                                        <i class="fas fa-lightbulb"></i> Suggest
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                @{
                                                    var progress = detail.TotalQuantity > 0 ? Math.Round((double)detail.AlreadyPutAwayQuantity / detail.TotalQuantity * 100) : 0;
                                                }
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-warning" role="progressbar" 
                                                         style="width: @progress%" 
                                                         aria-valuenow="@progress" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        @progress%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Bulk Actions -->
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-success" onclick="processAllItems()">
                                        <i class="fas fa-bolt"></i> Process All Items
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="suggestAllLocations()">
                                        <i class="fas fa-magic"></i> Suggest All Locations
                                    </button>
                                </div>
                                <div>
                                    <span class="text-muted">
                                        <span id="pendingCount">@itemsToPutaway.Count</span> items pending
                                    </span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

<!-- Completed Items Section -->
@if (completedItems.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success bg-opacity-10">
                    <h5 class="card-title mb-0 text-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Completed Items (@completedItems.Count items)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-success">
                                <tr>
                                    <th>Item</th>
                                    <th class="text-center">Unit</th>
                                    <th class="text-center">Total Qty</th>
                                    <th class="text-center">Put Away</th>
                                    <th class="text-center">Price/Unit</th>
                                    <th class="text-center">Total Value</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detail in completedItems)
                                {
                                    var totalValue = detail.TotalQuantity * detail.ActualPricePerItem;
                                    var progress = detail.TotalQuantity > 0 ? Math.Round((double)detail.AlreadyPutAwayQuantity / detail.TotalQuantity * 100) : 0;
                                    <tr class="table-success">
                                        <td>
                                            <div>
                                                <strong>@detail.ItemCode</strong>
                                                <br><small class="text-muted">@detail.ItemName</small>
                                            </div>
                                        </td>
                                        <td class="text-center">@detail.ItemUnit</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@detail.TotalQuantity</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">@detail.AlreadyPutAwayQuantity</span>
                                        </td>
                                        <td class="text-center">
                                            <strong>@detail.ActualPricePerItem.ToString("C")</strong>
                                        </td>
                                        <td class="text-center">
                                            <strong>@totalValue.ToString("C")</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">Completed</span>
                                        </td>
                                        <td class="text-center">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: @progress%" 
                                                     aria-valuenow="@progress" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    @progress%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (!itemsToPutaway.Any() && !completedItems.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">No items found for this ASN</h5>
                        <p class="text-muted">This ASN may not have any details yet.</p>
                        <a href="@Url.Action("Putaway", "Inventory")" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Back to Putaway List
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Progress Summary -->
@if (Model.PutawayDetails.Any())
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Progress Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">@Model.PutawayDetails.Count</h4>
                                <small class="text-muted">Total Items</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">@Model.PutawayDetails.Count(d => d.IsCompleted)</h4>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">@Model.PutawayDetails.Count(d => !d.IsCompleted)</h4>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">@Model.PutawayDetails.Sum(d => d.RemainingQuantity)</h4>
                                <small class="text-muted">Total Quantity</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress mt-3" style="height: 25px;">
                        @{
                            var completedPercentage = Model.PutawayDetails.Any() ? 
                                (double)Model.PutawayDetails.Count(d => d.IsCompleted) / Model.PutawayDetails.Count * 100 : 0;
                        }
                        <div class="progress-bar bg-success" 
                             role="progressbar" 
                             style="width: @completedPercentage%"
                             aria-valuenow="@completedPercentage" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @completedPercentage.ToString("F0")% Complete
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<script>
        
        // Suggest location for single item
        function suggestLocation(index) {
            // This would typically make an AJAX call to get location suggestions
            alert('Location suggestion feature would be implemented here');
        }
        
        // Suggest all locations
        function suggestAllLocations() {
            // This would typically make an AJAX call to get location suggestions for all items
            alert('Bulk location suggestion feature would be implemented here');
        }
        
        // Update pending count display
        function updatePendingCount() {
            const pendingCountElement = document.getElementById('pendingCount');
            if (pendingCountElement) {
                const pendingRows = document.querySelectorAll('#putawayForm tbody tr').length;
                pendingCountElement.textContent = pendingRows;
            }
        }

        // Location capacity validation
        function validateLocationCapacity(selectElement, requiredQuantity) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const availableCapacity = parseInt(selectedOption.dataset.available);
            const maxCapacity = parseInt(selectedOption.dataset.max);
            const currentCapacity = parseInt(selectedOption.dataset.current);
            const status = selectedOption.dataset.status;
            
            // Get warning element
            const rowIndex = selectElement.name.match(/\[(\d+)\]/)[1];
            const warningElement = document.getElementById(`warning-${rowIndex}`);
            const warningText = warningElement.querySelector('.warning-text');
            
            // Clear previous warnings
            warningElement.style.display = 'none';
            selectElement.classList.remove('is-invalid');
            
            if (selectElement.value === '') {
                return true; // No location selected yet
            }
            
            // Check if location can accommodate the quantity
            if (availableCapacity < requiredQuantity) {
                warningText.textContent = `Insufficient capacity! Available: ${availableCapacity}, Required: ${requiredQuantity}`;
                warningElement.style.display = 'block';
                selectElement.classList.add('is-invalid');
                return false;
            }
            
            // Show capacity warnings based on available capacity
            if (availableCapacity <= 5) {
                warningText.textContent = `CRITICAL: Only ${availableCapacity} units available!`;
                warningElement.style.display = 'block';
                warningElement.querySelector('small').className = 'text-danger fw-bold';
            } else if (availableCapacity <= 20) {
                warningText.textContent = `WARNING: Only ${availableCapacity} units available`;
                warningElement.style.display = 'block';
                warningElement.querySelector('small').className = 'text-warning fw-bold';
            }
            
            return true;
        }

        // Validate all locations before processing
        function validateAllLocations() {
            let allValid = true;
            const locationSelects = document.querySelectorAll('.location-select');
            
            locationSelects.forEach(select => {
                const quantity = parseInt(select.dataset.quantity);
                if (!validateLocationCapacity(select, quantity)) {
                    allValid = false;
                }
            });
            
            return allValid;
        }

        // Update processSingleItem to include validation
        function processSingleItem(index, asnDetailId) {
            const form = document.getElementById('putawayForm');
            const quantityInput = form.querySelector(`input[name="PutawayDetails[${index}].QuantityToPutaway"]`);
            const locationSelect = form.querySelector(`select[name="PutawayDetails[${index}].LocationId"]`);
            const asnDetailIdInput = form.querySelector(`input[name="PutawayDetails[${index}].ASNDetailId"]`);
            
            // Use asnDetailId parameter if input not found
            const actualAsnDetailId = asnDetailIdInput ? asnDetailIdInput.value : asnDetailId;
            
            // Debug logging
            console.log('Processing item at index:', index);
            console.log('ASN Detail ID:', asnDetailIdInput ? asnDetailIdInput.value : 'NOT FOUND');
            console.log('Quantity:', quantityInput ? quantityInput.value : 'NOT FOUND');
            console.log('Location ID:', locationSelect ? locationSelect.value : 'NOT FOUND');
            
            if (!quantityInput || !quantityInput.value || quantityInput.value <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (!locationSelect || !locationSelect.value) {
                alert('Please select a location');
                return;
            }
            
            if (!actualAsnDetailId) {
                alert('ASN Detail ID not found');
                return;
            }
            
            // Validate location capacity
            const quantity = parseInt(quantityInput.value);
            if (!validateLocationCapacity(locationSelect, quantity)) {
                alert('Selected location cannot accommodate the required quantity. Please choose a different location.');
                return;
            }
            
            if (confirm(`Process ${quantityInput.value} units to location ${locationSelect.options[locationSelect.selectedIndex].text}?`)) {
                // Prepare form data for AJAX submission
                const formData = new FormData();
                
                // Add CSRF token
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }
                
                // Add the specific item data
                formData.append('asnDetailId', actualAsnDetailId);
                formData.append('quantityToPutaway', quantityInput.value);
                formData.append('locationId', locationSelect.value);
                formData.append('asnId', '@Model.ASNId');
                formData.append('itemId', quantityInput.getAttribute('data-item-id') || '');
                
                console.log('Submitting AJAX request with values:');
                console.log('asnDetailId:', actualAsnDetailId);
                console.log('quantityToPutaway:', quantityInput.value);
                console.log('locationId:', locationSelect.value);
                console.log('asnId:', '@Model.ASNId');
                console.log('itemId:', quantityInput.getAttribute('data-item-id'));
                
                // Show loading state - Find button using data attribute (more reliable than querySelector with onclick)
                const processBtn = quantityInput.closest('tr').querySelector(`button.process-putaway-btn[data-index="${index}"]`);
                const originalBtnText = processBtn ? processBtn.innerHTML : '';
                if (processBtn) {
                    processBtn.disabled = true;
                    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                }
                
                // Make AJAX request
                fetch('@Url.Action("ProcessPutaway")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Putaway response:', data);
                    
                    if (data.success) {
                        // Show success message
                        const successMessage = data.message || 'Putaway processed successfully!';
                        
                        // Check if item is now completed
                        if (data.data && data.data.remainingQuantity === 0) {
                            // Item is fully completed - reload page to show in Completed Items section
                            alert(successMessage + '\n\nPage will refresh to show completed items.');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                            return; // Exit early since we're reloading
                        }
                        
                        // Item still has remaining quantity - update UI dynamically
                        alert(successMessage);
                        
                        // Update remaining quantity display
                        const row = quantityInput.closest('tr');
                        const remainingBadge = row.querySelector('.badge.bg-warning');
                        const putAwayBadge = row.querySelector('.badge.bg-success');
                        
                        if (remainingBadge && data.data) {
                            remainingBadge.textContent = data.data.remainingQuantity;
                        }
                        
                        if (putAwayBadge && data.data) {
                            putAwayBadge.textContent = data.data.alreadyPutAwayQuantity;
                        }
                        
                        // Update progress bar
                        if (data.data && data.data.totalQuantity > 0) {
                            const progress = Math.round((data.data.alreadyPutAwayQuantity / data.data.totalQuantity) * 100);
                            const progressBar = row.querySelector('.progress-bar');
                            if (progressBar) {
                                progressBar.style.width = `${progress}%`;
                                progressBar.textContent = `${progress}%`;
                                progressBar.setAttribute('aria-valuenow', progress);
                                
                                // Update color based on progress
                                progressBar.classList.remove('bg-warning', 'bg-success');
                                if (progress === 100) {
                                    progressBar.classList.add('bg-success');
                                } else {
                                    progressBar.classList.add('bg-warning');
                                }
                            }
                        } else {
                            // Fallback: calculate from DOM elements
                            const totalQtyBadge = row.querySelector('.badge.bg-info');
                            if (totalQtyBadge && data.data) {
                                const totalQty = parseInt(totalQtyBadge.textContent);
                                if (totalQty > 0) {
                                    const progress = Math.round((data.data.alreadyPutAwayQuantity / totalQty) * 100);
                                    const progressBar = row.querySelector('.progress-bar');
                                    if (progressBar) {
                                        progressBar.style.width = `${progress}%`;
                                        progressBar.textContent = `${progress}%`;
                                        progressBar.setAttribute('aria-valuenow', progress);
                                        
                                        progressBar.classList.remove('bg-warning', 'bg-success');
                                        if (progress === 100) {
                                            progressBar.classList.add('bg-success');
                                        } else {
                                            progressBar.classList.add('bg-warning');
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Update quantity input max value
                        if (quantityInput && data.data) {
                            quantityInput.max = data.data.remainingQuantity;
                            if (parseInt(quantityInput.value) > data.data.remainingQuantity) {
                                quantityInput.value = data.data.remainingQuantity;
                            }
                        }
                        
                        // Update pending count
                        updatePendingCount();
                        
                        // If no remaining quantity left, reload to move item to Completed section
                        if (data.data && data.data.remainingQuantity === 0) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        }
                    } else {
                        alert(data.message || 'Error processing putaway');
                    }
                })
                .catch(error => {
                    console.error('Error processing putaway:', error);
                    alert('Error processing putaway: ' + error.message);
                })
                .finally(() => {
                    // Restore button state
                    if (processBtn && originalBtnText) {
                        processBtn.disabled = false;
                        processBtn.innerHTML = originalBtnText;
                    }
                });
            }
        }
        
        // Update processAllItems to include validation
        function processAllItems() {
            if (!validateAllLocations()) {
                alert('Some locations cannot accommodate the required quantities. Please check the warnings and select different locations.');
                return;
            }
            
            if (confirm('Process all remaining items with their current settings?')) {
                document.getElementById('putawayForm').submit();
            }
        }
</script>
