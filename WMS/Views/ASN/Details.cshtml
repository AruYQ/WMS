@model int
@{
    ViewData["Title"] = "ASN Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-truck me-2"></i>
                        ASN Details
                    </h2>
                    <p class="text-muted mb-0">ASN Number: <strong id="asnNumberDisplay">-</strong></p>
                </div>
                <div>
                    <a href="/ASN" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to ASN List
                    </a>
                    <button type="button" class="btn btn-primary" onclick="loadASNDetails()">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ASN Information Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        ASN Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">ASN Number:</label>
                            <p id="asnNumber" class="mb-0 fs-5 text-primary fw-bold">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Purchase Order:</label>
                            <p id="poNumber" class="mb-0">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Supplier:</label>
                            <p id="supplierName" class="mb-0 fw-medium">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Status:</label>
                            <p id="asnStatus" class="mb-0">-</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Shipment Date:</label>
                            <p id="shipmentDate" class="mb-0">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Expected Arrival:</label>
                            <p id="expectedArrivalDate" class="mb-0">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Actual Arrival:</label>
                            <p id="actualArrivalDate" class="mb-0">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Carrier:</label>
                            <p id="carrierName" class="mb-0">-</p>
                            <small id="trackingNumber" class="text-muted">-</small>
                        </div>
                    </div>
                    <div class="row mt-3" id="notesRow" style="display: none;">
                        <div class="col-12">
                            <label class="form-label fw-bold text-muted">Notes:</label>
                            <p id="notes" class="mb-0 border p-2 rounded bg-light">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 class="text-primary" id="itemTypesCount">0</h4>
                            <small class="text-muted">Item Types</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-success" id="totalShippedCount">0</h4>
                            <small class="text-muted">Total Shipped</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-info" id="totalPutawayCount">0</h4>
                            <small class="text-muted">Total Putaway</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning" id="remainingCount">0</h4>
                            <small class="text-muted">Remaining</small>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar bg-success" id="putawayProgressBar" role="progressbar" style="width: 0%">
                            0%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes me-2"></i>
                        Shipment Items (<span id="itemsCount">0</span>)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 25%;">Item</th>
                                    <th style="width: 10%;" class="text-center">Unit</th>
                                    <th style="width: 15%;" class="text-end">Shipped Qty</th>
                                    <th style="width: 15%;" class="text-end">Putaway Qty</th>
                                    <th style="width: 15%;" class="text-end">Remaining</th>
                                    <th style="width: 15%;" class="text-end">Unit Price</th>
                                    <th style="width: 10%;" class="text-center">Progress</th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Purchase Order Link -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Related Purchase Order</h6>
                            <p id="relatedPO" class="mb-0 text-muted">-</p>
                        </div>
                        <div>
                            <a id="poLink" href="#" class="btn btn-outline-primary">
                                <i class="fas fa-external-link-alt me-1"></i>
                                View Purchase Order
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const asnId = @Model;

        document.addEventListener('DOMContentLoaded', function() {
            loadASNDetails();
        });

        async function loadASNDetails() {
            try {
                const response = await fetch(`/api/asn/${asnId}`);
                const result = await response.json();

                if (result.success) {
                    populateASNInfo(result.data);
                    populateItemsTable(result.data.details);
                    updateSummaryStats(result.data.details);
                } else {
                    showAlert('Error loading ASN details: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error loading ASN details:', error);
                showAlert('Error loading ASN details', 'error');
            }
        }

        function populateASNInfo(data) {
            document.getElementById('asnNumber').textContent = data.asnNumber;
            document.getElementById('asnNumberDisplay').textContent = data.asnNumber;
            document.getElementById('poNumber').textContent = data.purchaseOrderNumber;
            document.getElementById('supplierName').textContent = data.supplierName;
            document.getElementById('shipmentDate').textContent = data.shipmentDate ? new Date(data.shipmentDate).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '-';
            
            if (data.expectedArrivalDate) {
                const arrivalDate = new Date(data.expectedArrivalDate);
                let arrivalHtml = arrivalDate.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                if (data.status === 'On Delivery' || data.status === 'Pending') {
                    const daysUntil = Math.ceil((arrivalDate - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) {
                        arrivalHtml += `<br><small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${Math.abs(daysUntil)} days overdue</small>`;
                    } else if (daysUntil <= 1) {
                        arrivalHtml += `<br><small class="text-warning"><i class="fas fa-clock me-1"></i>Arriving ${daysUntil === 0 ? 'today' : 'tomorrow'}</small>`;
                    }
                }
                document.getElementById('expectedArrivalDate').innerHTML = arrivalHtml;
            } else {
                document.getElementById('expectedArrivalDate').textContent = '-';
            }
            
            document.getElementById('actualArrivalDate').textContent = data.actualArrivalDate ? new Date(data.actualArrivalDate).toLocaleDateString('id-ID') : '-';
            document.getElementById('carrierName').textContent = data.carrierName || '-';
            document.getElementById('trackingNumber').textContent = data.trackingNumber ? `Tracking: ${data.trackingNumber}` : '-';
            
            const statusBadge = getStatusBadge(data.status);
            document.getElementById('asnStatus').innerHTML = statusBadge;

            if (data.notes) {
                document.getElementById('notes').textContent = data.notes;
                document.getElementById('notesRow').style.display = 'block';
            }

            // Set related PO link
            document.getElementById('relatedPO').textContent = `PO Number: ${data.purchaseOrderNumber}`;
            document.getElementById('poLink').href = `/PurchaseOrder/Details/${data.purchaseOrderId}`;
        }

        function populateItemsTable(details) {
            const itemsBody = document.getElementById('itemsBody');
            itemsBody.innerHTML = '';

            if (!details || details.length === 0) {
                itemsBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No items</td></tr>';
                document.getElementById('itemsCount').textContent = '0';
                return;
            }

            details.forEach((detail, index) => {
                const row = document.createElement('tr');
                const progress = detail.shippedQuantity > 0 
                    ? Math.round((detail.alreadyPutAwayQuantity / detail.shippedQuantity) * 100) 
                    : 0;
                const progressBar = createProgressBar(progress);
                
                row.innerHTML = `
                    <td class="text-muted">${index + 1}</td>
                    <td>
                        <strong class="text-primary">${detail.itemCode}</strong><br>
                        <small class="text-muted">${detail.itemName}</small>
                        ${detail.notes ? `<br><small class="text-warning"><i class="fas fa-sticky-note me-1"></i>${detail.notes}</small>` : ''}
                    </td>
                    <td class="text-center">${detail.itemUnit || '-'}</td>
                    <td class="text-end">
                        <span class="badge bg-info">${detail.shippedQuantity.toLocaleString()}</span>
                    </td>
                    <td class="text-end">
                        <span class="badge bg-success">${detail.alreadyPutAwayQuantity?.toLocaleString() || 0}</span>
                    </td>
                    <td class="text-end">
                        <span class="badge bg-warning">${detail.remainingQuantity?.toLocaleString() || 0}</span>
                    </td>
                    <td class="text-end">${formatCurrency(detail.actualPricePerItem)}</td>
                    <td class="text-center">${progressBar}</td>
                `;
                itemsBody.appendChild(row);
            });

            document.getElementById('itemsCount').textContent = details.length;
        }

        function createProgressBar(percentage) {
            const progressClass = percentage === 100 ? 'bg-success' : 
                                 percentage > 0 ? 'bg-warning' : 'bg-secondary';
            
            return `
                <div class="progress" style="height: 20px; min-width: 60px;">
                    <div class="progress-bar ${progressClass}" role="progressbar" 
                         style="width: ${percentage}%" 
                         aria-valuenow="${percentage}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${percentage}%
                    </div>
                </div>
            `;
        }

        function updateSummaryStats(details) {
            if (!details || details.length === 0) {
                document.getElementById('itemTypesCount').textContent = '0';
                document.getElementById('totalShippedCount').textContent = '0';
                document.getElementById('totalPutawayCount').textContent = '0';
                document.getElementById('remainingCount').textContent = '0';
                return;
            }

            const totalShipped = details.reduce((sum, d) => sum + d.shippedQuantity, 0);
            const totalPutaway = details.reduce((sum, d) => sum + (d.alreadyPutAwayQuantity || 0), 0);
            const totalRemaining = details.reduce((sum, d) => sum + (d.remainingQuantity || 0), 0);
            const progress = totalShipped > 0 ? Math.round((totalPutaway / totalShipped) * 100) : 0;

            document.getElementById('itemTypesCount').textContent = details.length;
            document.getElementById('totalShippedCount').textContent = totalShipped.toLocaleString();
            document.getElementById('totalPutawayCount').textContent = totalPutaway.toLocaleString();
            document.getElementById('remainingCount').textContent = totalRemaining.toLocaleString();

            // Update progress bar
            const progressBar = document.getElementById('putawayProgressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
        }

        function getStatusBadge(status) {
            const badges = {
                'Pending': '<span class="badge bg-secondary">Pending</span>',
                'On Delivery': '<span class="badge bg-warning">On Delivery</span>',
                'Arrived': '<span class="badge bg-success">Arrived</span>',
                'Processed': '<span class="badge bg-primary">Processed</span>',
                'Cancelled': '<span class="badge bg-danger">Cancelled</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showAlert(message, type) {
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
}