@using WMS.Models.ViewModels
@model ASNViewModel
@{
    ViewData["Title"] = "Create ASN";
}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">
                <i class="fas fa-plus-circle me-2"></i>
                Create Advanced Shipping Notice
            </h1>
            <p class="page-subtitle">Create ASN for incoming shipments with warehouse fee calculations</p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to List
            </a>
        </div>
    </div>
</div>

<form id="asnForm" method="post" novalidate>
    <input asp-for="Id" type="hidden" />

    <div class="row">
        <!-- ASN Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        ASN Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="PurchaseOrderId" class="form-label">Purchase Order <span class="text-danger">*</span></label>
                                <select asp-for="PurchaseOrderId" asp-items="Model.PurchaseOrders" class="form-select" id="purchaseOrderSelect">
                                    <option value="">-- Select Purchase Order --</option>
                                </select>
                                <span asp-validation-for="PurchaseOrderId" class="text-danger small"></span>
                                <div class="form-text">Select the purchase order for this shipment</div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="ShipmentDate" class="form-label">Shipment Date <span class="text-danger">*</span></label>
                                <input asp-for="ShipmentDate" type="date" class="form-control" />
                                <span asp-validation-for="ShipmentDate" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="CarrierName" class="form-label">Carrier Name</label>
                                <input asp-for="CarrierName" class="form-control" placeholder="e.g., JNE, J&T, Sicepat..." />
                                <span asp-validation-for="CarrierName" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ExpectedArrivalDate" class="form-label">Expected Arrival Date</label>
                                <input asp-for="ExpectedArrivalDate" type="date" class="form-control" />
                                <span asp-validation-for="ExpectedArrivalDate" class="text-danger small"></span>
                                <div class="form-text">When do you expect the goods to arrive?</div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="TrackingNumber" class="form-label">Tracking Number</label>
                                <input asp-for="TrackingNumber" class="form-control" placeholder="Enter tracking/receipt number..." />
                                <span asp-validation-for="TrackingNumber" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Total Warehouse Fee</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" class="form-control" id="totalWarehouseFee" value="0" readonly />
                                </div>
                                <div class="form-text">Calculated automatically from actual prices below</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="Notes" class="form-label">Notes</label>
                                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Any additional notes about this shipment..."></textarea>
                                <span asp-validation-for="Notes" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Order Reference -->
            <div class="card mb-4" id="poReferenceCard" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        Purchase Order Reference
                        <span class="badge bg-info ms-2" id="poNumber"></span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2"><strong>Supplier:</strong> <span id="supplierName"></span></div>
                        </div>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-sm" id="poDetailsTable">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Unit</th>
                                    <th class="text-end">Ordered Qty</th>
                                    <th class="text-end">Ordered Price</th>
                                </tr>
                            </thead>
                            <tbody id="poDetailsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ASN Items -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-boxes me-2"></i>
                            Actual Shipment Items & Warehouse Fee
                        </h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addItem()" id="addItemBtn" disabled>
                            <i class="fas fa-plus"></i>
                            Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="itemsTable">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Item</th>
                                    <th style="width: 8%;">Unit</th>
                                    <th style="width: 10%;">Ordered</th>
                                    <th style="width: 10%;">Shipped</th>
                                    <th style="width: 15%;">Actual Price</th>
                                    <th style="width: 10%;">Fee Rate</th>
                                    <th style="width: 12%;">Fee Amount</th>
                                    <th style="width: 10%;">Total Fee</th>
                                    <th style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically here -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <th colspan="7" class="text-end">Total Warehouse Fee:</th>
                                    <th id="grandTotalFee" class="text-success">Rp 0</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="noItemsMessage" class="text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Items Added</h5>
                        <p class="text-muted">Select a Purchase Order first, then add the actual shipped items with their real prices.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ASN Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Warehouse Fee Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="h3 text-primary mb-1" id="itemCount">0</div>
                            <div class="small text-muted">Items</div>
                        </div>
                        <div class="col-6">
                            <div class="h3 text-success mb-1" id="totalQuantity">0</div>
                            <div class="small text-muted">Total Qty</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Low Fee (≤ 1M):</span>
                            <span class="fw-bold text-success" id="lowFeeCount">0 items</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Medium Fee (1-10M):</span>
                            <span class="fw-bold text-warning" id="mediumFeeCount">0 items</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>High Fee (>10M):</span>
                            <span class="fw-bold text-danger" id="highFeeCount">0 items</span>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total Warehouse Fee:</span>
                        <span class="fw-bold text-success h5" id="totalDisplay">Rp 0</span>
                    </div>

                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Fee rates: 3% (≤1M), 2% (1-10M), 1% (>10M)</small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="saveButton" disabled>
                            <i class="fas fa-save"></i>
                            Create ASN
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-eraser"></i>
                            Clear Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Add Item to ASN
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Select Item <span class="text-danger">*</span></label>
                                <select id="itemSelect" class="form-select">
                                    <option value="">-- Select Item --</option>
                                </select>
                                <div class="invalid-feedback">Please select an item.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unit</label>
                                <input type="text" id="itemUnit" class="form-control" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ordered Qty</label>
                                <input type="number" id="orderedQuantity" class="form-control" readonly />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Shipped Qty <span class="text-danger">*</span></label>
                                <input type="number" id="shippedQuantity" class="form-control" min="1" step="1" />
                                <div class="invalid-feedback">Please enter shipped quantity.</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ordered Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" id="orderedPrice" class="form-control" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Actual Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="number" id="actualPrice" class="form-control" min="0" step="0.01" />
                                </div>
                                <div class="invalid-feedback">Please enter actual price.</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Fee Rate</label>
                                <input type="text" id="feeRate" class="form-control" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Fee per Item</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" id="feeAmount" class="form-control" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Total Fee</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" id="totalItemFee" class="form-control" readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info" id="feeInfo" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="feeInfoText"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea id="itemNotes" class="form-control" rows="2" placeholder="Any special notes for this item..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">
                    <i class="fas fa-plus"></i>
                    Add Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let itemIndex = 0;
        let items = [];
        let poDetails = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing ASN form...');

            // Load PO details when PO is selected
            const purchaseOrderSelect = document.getElementById('purchaseOrderSelect');
            if (purchaseOrderSelect) {
                purchaseOrderSelect.addEventListener('change', function() {
                    const poId = this.value;
                    console.log('PO selected:', poId);
                    if (poId) {
                        loadPODetails(poId);
                    } else {
                        hidePOReference();
                    }
                });
            }

            // Auto-fill item details when item is selected
            const itemSelect = document.getElementById('itemSelect');
            if (itemSelect) {
                itemSelect.addEventListener('change', function() {
                    const itemId = parseInt(this.value);
                    console.log('Item selected:', itemId);

                    if (itemId && poDetails.length > 0) {
                        const poDetail = poDetails.find(d => d.itemId === itemId);
                        if (poDetail) {
                            const itemUnit = document.getElementById('itemUnit');
                            const orderedQuantity = document.getElementById('orderedQuantity');
                            const orderedPrice = document.getElementById('orderedPrice');
                            const actualPrice = document.getElementById('actualPrice');
                            const shippedQuantity = document.getElementById('shippedQuantity');

                            if (itemUnit) itemUnit.value = poDetail.itemUnit || '';
                            if (orderedQuantity) orderedQuantity.value = poDetail.orderedQuantity || 0;
                            if (orderedPrice) orderedPrice.value = formatCurrency(poDetail.orderedPrice || 0);
                            if (actualPrice) actualPrice.value = poDetail.orderedPrice || 0;
                            if (shippedQuantity) shippedQuantity.value = poDetail.orderedQuantity || 0;

                            calculateWarehouseFee();
                        }
                    } else {
                        clearItemForm();
                    }
                });
            }

            // Calculate fee when actual price or quantity changes
            const actualPriceInput = document.getElementById('actualPrice');
            const shippedQuantityInput = document.getElementById('shippedQuantity');

            if (actualPriceInput) {
                actualPriceInput.addEventListener('input', calculateWarehouseFee);
                actualPriceInput.addEventListener('change', calculateWarehouseFee);
            }

            if (shippedQuantityInput) {
                shippedQuantityInput.addEventListener('input', calculateWarehouseFee);
                shippedQuantityInput.addEventListener('change', calculateWarehouseFee);
            }

            updateDisplay();
        });

        async function loadPODetails(poId) {
            try {
                console.log('Loading PO details for ID:', poId);

                // Show loading state
                const addItemBtn = document.getElementById('addItemBtn');
                const originalBtnText = addItemBtn.innerHTML;
                addItemBtn.disabled = true;
                addItemBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';

                const response = await fetch(`/ASN/GetPODetails?purchaseOrderId=${poId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('PO Details response:', data);

                if (data && data.success && data.details) {
                    // Check if PO status is "Closed" (not "Sent")
                    if (data.status === 'Closed') {
                        showError('This Purchase Order is already closed and cannot be used for new ASN.');
                        // Reset the dropdown
                        const purchaseOrderSelect = document.getElementById('purchaseOrderSelect');
                        if (purchaseOrderSelect) {
                            purchaseOrderSelect.value = '';
                        }
                        hidePOReference();
                        return;
                    }

                    // Show PO reference
                    const poNumber = document.getElementById('poNumber');
                    const supplierName = document.getElementById('supplierName');
                    const poReferenceCard = document.getElementById('poReferenceCard');

                    if (poNumber) poNumber.textContent = data.poNumber || 'N/A';
                    if (supplierName) supplierName.textContent = data.supplierName || 'N/A';
                    if (poReferenceCard) poReferenceCard.style.display = 'block';

                    // Populate PO details table
                    const tbody = document.getElementById('poDetailsBody');
                    if (tbody) {
                        tbody.innerHTML = data.details.map(detail => `
                            <tr>
                                <td><strong>${detail.itemCode || ''}</strong><br><small>${detail.itemName || ''}</small></td>
                                <td>${detail.itemUnit || ''}</td>
                                <td class="text-end">${formatNumber(detail.orderedQuantity || 0)}</td>
                                <td class="text-end">${formatCurrency(detail.orderedPrice || 0)}</td>
                            </tr>
                        `).join('');
                    }

                    // Store PO details for item selection
                    poDetails = data.details;

                    // Populate item select dropdown
                    const itemSelect = document.getElementById('itemSelect');
                    if (itemSelect) {
                        itemSelect.innerHTML = '<option value="">-- Select Item --</option>' +
                            data.details.map(detail =>
                                `<option value="${detail.itemId}">${detail.itemCode || ''} - ${detail.itemName || ''}</option>`
                            ).join('');
                    }

                    // Enable buttons
                    addItemBtn.disabled = false;
                    addItemBtn.innerHTML = originalBtnText;
                    const saveButton = document.getElementById('saveButton');
                    if (saveButton) saveButton.disabled = false;

                    console.log('PO details loaded successfully');
                } else {
                    throw new Error(data?.message || 'No details found for selected purchase order');
                }
            } catch (error) {
                console.error('Error loading PO details:', error);
                showError('Error loading purchase order details: ' + error.message);
                hidePOReference();
            }
        }

        function hidePOReference() {
            const poReferenceCard = document.getElementById('poReferenceCard');
            const addItemBtn = document.getElementById('addItemBtn');
            const saveButton = document.getElementById('saveButton');

            if (poReferenceCard) poReferenceCard.style.display = 'none';
            if (addItemBtn) {
                addItemBtn.disabled = true;
                addItemBtn.innerHTML = '<i class="fas fa-plus"></i> Add Item';
            }
            if (saveButton) saveButton.disabled = true;

            poDetails = [];
            items = [];
            updateDisplay();
        }

        function addItem() {
            console.log('Opening add item modal...');

            // Check if PO is selected
            if (poDetails.length === 0) {
                showError('Please select a Purchase Order first.');
                return;
            }

            // Reset and clear form
            clearItemForm();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        function clearItemForm() {
            // Reset form inputs
            const form = document.getElementById('itemForm');
            if (form) {
                form.reset();
            }

            // Clear calculated fields with null checks
            const elements = [
                'itemUnit', 'orderedQuantity', 'orderedPrice',
                'shippedQuantity', 'actualPrice'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });

            clearFeeCalculation();

            // Remove validation classes
            document.querySelectorAll('#itemForm .form-control, #itemForm .form-select').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
        }

        function clearFeeCalculation() {
            // Add null checks for all modal elements
            const feeRate = document.getElementById('feeRate');
            const feeAmount = document.getElementById('feeAmount');
            const totalItemFee = document.getElementById('totalItemFee');
            const feeInfo = document.getElementById('feeInfo');

            if (feeRate) feeRate.value = '';
            if (feeAmount) feeAmount.value = '';
            if (totalItemFee) totalItemFee.value = '';
            if (feeInfo) feeInfo.style.display = 'none';
        }

        async function calculateWarehouseFee() {
            const actualPriceElement = document.getElementById('actualPrice');
            const shippedQuantityElement = document.getElementById('shippedQuantity');

            if (!actualPriceElement || !shippedQuantityElement) {
                console.log('Price or quantity elements not found');
                return;
            }

            const actualPrice = parseFloat(actualPriceElement.value) || 0;
            const shippedQuantity = parseInt(shippedQuantityElement.value) || 0;

            console.log('Calculating fee for price:', actualPrice, 'quantity:', shippedQuantity);

            if (actualPrice > 0) {
                // Use corrected warehouse fee calculation from JavaScript logic
                var feeRate;
                var tier;
                var tierClass;
                var tierDescription;

                if (actualPrice <= 1000000) {
                    feeRate = 0.03; // 3%
                    tier = "Low";
                    tierClass = "text-success";
                    tierDescription = "≤ 1 Juta (3%)";
                } else if (actualPrice <= 10000000) {
                    feeRate = 0.02; // 2%
                    tier = "Medium";
                    tierClass = "text-warning";
                    tierDescription = "1-10 Juta (2%)";
                } else {
                    feeRate = 0.01; // 1%
                    tier = "High";
                    tierClass = "text-danger";
                    tierDescription = "> 10 Juta (1%)";
                }

                const feeAmount = actualPrice * feeRate;
                const feePercentage = (feeRate * 100).toFixed(2) + '%';

                const feeRateElement = document.getElementById('feeRate');
                const feeAmountElement = document.getElementById('feeAmount');
                const totalItemFee = document.getElementById('totalItemFee');
                const feeInfo = document.getElementById('feeInfo');
                const feeInfoText = document.getElementById('feeInfoText');

                if (feeRateElement) feeRateElement.value = feePercentage;
                if (feeAmountElement) feeAmountElement.value = formatCurrency(feeAmount);
                if (totalItemFee) totalItemFee.value = formatCurrency(feeAmount * shippedQuantity);

                // Show fee info
                if (feeInfo && feeInfoText) {
                    feeInfoText.innerHTML = `
                        <strong>${tier}</strong> - Fee Rate: ${feePercentage}
                        <span class="${tierClass} ms-2">${tierDescription}</span>
                    `;
                    feeInfo.style.display = 'block';
                    feeInfo.className = 'alert alert-info';
                }
            } else {
                clearFeeCalculation();
            }
        }

        function saveItem() {
            console.log('Attempting to save item...');

            const itemSelect = document.getElementById('itemSelect');
            const shippedQuantity = document.getElementById('shippedQuantity');
            const actualPrice = document.getElementById('actualPrice');
            const notes = document.getElementById('itemNotes');

            console.log('Form values:', {
                itemId: itemSelect?.value,
                shippedQty: shippedQuantity?.value,
                actualPrice: actualPrice?.value,
                notes: notes?.value
            });

            // Clear previous validation
            document.querySelectorAll('#itemForm .form-control, #itemForm .form-select').forEach(input => {
                input.classList.remove('is-invalid');
            });

            // Validate required fields
            let isValid = true;
            let errorMessages = [];

            if (!itemSelect?.value) {
                itemSelect?.classList.add('is-invalid');
                errorMessages.push('Please select an item');
                isValid = false;
            }

            if (!shippedQuantity?.value || parseInt(shippedQuantity.value) <= 0) {
                shippedQuantity?.classList.add('is-invalid');
                errorMessages.push('Please enter a valid shipped quantity');
                isValid = false;
            }

            if (!actualPrice?.value || parseFloat(actualPrice.value) <= 0) {
                actualPrice?.classList.add('is-invalid');
                errorMessages.push('Please enter a valid actual price');
                isValid = false;
            }

            if (!isValid) {
                showError('Validation failed: ' + errorMessages.join(', '));
                return;
            }

            // Check for duplicate items
            const selectedItemId = parseInt(itemSelect.value);
            const existingItem = items.find(item => item.itemId === selectedItemId);
            if (existingItem) {
                showError('This item is already added to the ASN.');
                itemSelect.classList.add('is-invalid');
                return;
            }

            // Calculate fee with corrected rates
            const actualPriceValue = parseFloat(actualPrice.value);
            let feeRate;

            if (actualPriceValue <= 1000000) {
                feeRate = 0.03; // 3%
            } else if (actualPriceValue <= 10000000) {
                feeRate = 0.02; // 2%
            } else {
                feeRate = 0.01; // 1%
            }

            const feeAmount = actualPriceValue * feeRate;

            console.log('Fee calculation:', { feeRate, feeAmount });

            if (isNaN(feeRate) || isNaN(feeAmount)) {
                showError('Warehouse fee calculation failed. Please check the actual price and try again.');
                return;
            }

            // Find the corresponding PO detail
            const poDetail = poDetails.find(d => d.itemId === selectedItemId);
            if (!poDetail) {
                showError('Selected item not found in purchase order details.');
                return;
            }

            // Create new item object
            const newItem = {
                id: itemIndex++,
                itemId: selectedItemId,
                itemCode: poDetail.itemCode || '',
                itemName: poDetail.itemName || '',
                itemUnit: poDetail.itemUnit || '',
                orderedQuantity: poDetail.orderedQuantity || 0,
                orderedPrice: poDetail.orderedPrice || 0,
                shippedQuantity: parseInt(shippedQuantity.value),
                actualPrice: parseFloat(actualPrice.value),
                feeRate: feeRate,
                feeAmount: feeAmount,
                totalFee: feeAmount * parseInt(shippedQuantity.value),
                notes: notes?.value || ''
            };

            console.log('Adding new item:', newItem);

            // Add item to array
            items.push(newItem);
            updateDisplay();

            // Close modal safely
            const modalElement = document.getElementById('addItemModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    // Create new modal instance and hide
                    const newModal = new bootstrap.Modal(modalElement);
                    newModal.hide();
                }
            }

            console.log('Item added successfully, total items:', items.length);
            showSuccess('Item added successfully!');
        }

        function removeItem(id) {
            console.log('Removing item with ID:', id);
            if (confirm('Are you sure you want to remove this item?')) {
                const itemsBefore = items.length;
                items = items.filter(item => item.id !== id);
                console.log('Items before:', itemsBefore, 'Items after:', items.length);
                updateDisplay();
                showSuccess('Item removed successfully!');
            }
        }

        function updateDisplay() {
            const tbody = document.getElementById('itemsTableBody');
            const noItemsMessage = document.getElementById('noItemsMessage');
            const itemsTable = document.querySelector('#itemsTable');

            console.log('Updating display with', items.length, 'items');

            if (items.length === 0) {
                if (tbody) tbody.innerHTML = '';
                if (noItemsMessage) noItemsMessage.style.display = 'block';
                if (itemsTable) itemsTable.style.display = 'none';
            } else {
                if (noItemsMessage) noItemsMessage.style.display = 'none';
                if (itemsTable) itemsTable.style.display = 'table';

                if (tbody) {
                    tbody.innerHTML = items.map((item, index) => {
                        // Updated fee rate classes for new rates (3%, 2%, 1%)
                        const feeRateClass = item.feeRate >= 0.03 ? 'badge bg-success' :
                                           item.feeRate >= 0.02 ? 'badge bg-warning' : 'badge bg-danger';

                        return `
                            <tr>
                                <td>
                                    <div class="fw-medium">${item.itemCode}</div>
                                    <div class="small text-muted">${item.itemName}</div>
                                    <input type="hidden" name="Details[${index}].ItemId" value="${item.itemId}" />
                                </td>
                                <td>${item.itemUnit}</td>
                                <td class="text-end">${formatNumber(item.orderedQuantity)}</td>
                                <td class="text-end">
                                    ${formatNumber(item.shippedQuantity)}
                                    <input type="hidden" name="Details[${index}].ShippedQuantity" value="${item.shippedQuantity}" />
                                </td>
                                <td class="text-end">
                                    ${formatCurrency(item.actualPrice)}
                                    <input type="hidden" name="Details[${index}].ActualPricePerItem" value="${item.actualPrice}" />
                                </td>
                                <td class="text-center">
                                    <span class="${feeRateClass}">${(item.feeRate * 100).toFixed(2)}%</span>
                                    <input type="hidden" name="Details[${index}].WarehouseFeeRate" value="${item.feeRate}" />
                                </td>
                                <td class="text-end">
                                    ${formatCurrency(item.feeAmount)}
                                    <input type="hidden" name="Details[${index}].WarehouseFeeAmount" value="${item.feeAmount}" />
                                </td>
                                <td class="text-end fw-medium text-success">
                                    ${formatCurrency(item.totalFee)}
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})" title="Remove Item">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <input type="hidden" name="Details[${index}].Notes" value="${item.notes || ''}" />
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // Update summary statistics
            const totalFee = items.reduce((sum, item) => sum + (item.totalFee || 0), 0);
            const totalQuantity = items.reduce((sum, item) => sum + (item.shippedQuantity || 0), 0);

            // Count fee tiers (updated rates: 3%, 2%, 1%)
            const lowFeeItems = items.filter(item => (item.actualPrice || 0) <= 1000000).length;
            const mediumFeeItems = items.filter(item => (item.actualPrice || 0) > 1000000 && (item.actualPrice || 0) <= 10000000).length;
            const highFeeItems = items.filter(item => (item.actualPrice || 0) > 10000000).length;

            // Update display elements with null checks
            const elements = {
                'itemCount': items.length,
                'totalQuantity': formatNumber(totalQuantity),
                'grandTotalFee': formatCurrency(totalFee),
                'totalDisplay': formatCurrency(totalFee),
                'lowFeeCount': `${lowFeeItems} items`,
                'mediumFeeCount': `${mediumFeeItems} items`,
                'highFeeCount': `${highFeeItems} items`
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            const totalWarehouseFee = document.getElementById('totalWarehouseFee');
            if (totalWarehouseFee) totalWarehouseFee.value = totalFee;

            console.log('Display updated - Total fee:', totalFee, 'Total items:', items.length);
        }

        function clearForm() {
            if (confirm('Are you sure you want to clear the form? All data will be lost.')) {
                const asnForm = document.getElementById('asnForm');
                if (asnForm) asnForm.reset();

                items = [];
                poDetails = [];
                itemIndex = 0;
                hidePOReference();
                updateDisplay();
                showSuccess('Form cleared successfully!');
            }
        }

        function formatCurrency(amount) {
            if (isNaN(amount) || amount === null || amount === undefined) {
                amount = 0;
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(number) {
            if (isNaN(number) || number === null || number === undefined) {
                number = 0;
            }
            return new Intl.NumberFormat('id-ID').format(number);
        }

        function showError(message) {
            console.error('Error:', message);

            // Remove existing error alerts
            document.querySelectorAll('.alert-danger').forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const pageHeader = document.querySelector('.page-header');
            if (pageHeader && pageHeader.parentNode) {
                pageHeader.parentNode.insertBefore(alertDiv, pageHeader.nextSibling);
            }

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showSuccess(message) {
            console.log('Success:', message);

            // Remove existing success alerts
            document.querySelectorAll('.alert-success').forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const pageHeader = document.querySelector('.page-header');
            if (pageHeader && pageHeader.parentNode) {
                pageHeader.parentNode.insertBefore(alertDiv, pageHeader.nextSibling);
            }

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const asnForm = document.getElementById('asnForm');
            if (asnForm) {
                asnForm.addEventListener('submit', function(e) {
                    console.log('Form submission attempted, items count:', items.length);

                    if (items.length === 0) {
                        e.preventDefault();
                        showError('Please add at least one item to the ASN.');
                        return false;
                    }

                    // Validate PO selection
                    const poId = document.getElementById('purchaseOrderSelect')?.value;
                    if (!poId) {
                        e.preventDefault();
                        showError('Please select a Purchase Order.');
                        return false;
                    }

                    console.log('Form validation passed, submitting...');

                    // Show loading state
                    const submitBtn = document.getElementById('saveButton');
                    if (submitBtn) {
                        const originalText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating ASN...';

                        // Re-enable button after timeout (in case of error)
                        setTimeout(() => {
                            if (submitBtn.disabled) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            }
                        }, 10000);
                    }

                    return true;
                });
            }
        });

        // Global function for modal button click
        window.addItem = addItem;
        window.saveItem = saveItem;
        window.removeItem = removeItem;
        window.clearForm = clearForm;

        console.log('ASN form JavaScript initialized successfully');
    </script>
}