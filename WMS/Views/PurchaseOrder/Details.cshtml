@model int
@{
    ViewData["Title"] = "Purchase Order Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                <i class="fas fa-file-invoice me-2"></i>
                Purchase Order Details
                    </h2>
                    <p class="text-muted mb-0">PO Number: <strong id="poNumberDisplay">-</strong></p>
        </div>
                <div>
                    <a href="/PurchaseOrder" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to PO List
                    </a>
                    <button type="button" class="btn btn-primary" onclick="loadPODetails()">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
            </div>
        </div>
    </div>
</div>

    <!-- PO Information Card -->
<div class="row mb-4">
        <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Purchase Order Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">PO Number:</label>
                            <p id="poNumber" class="mb-0 fs-5 text-primary fw-bold">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Supplier:</label>
                            <p id="supplierName" class="mb-0 fw-medium">-</p>
                            <small id="supplierEmail" class="text-muted">-</small>
                                </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Order Date:</label>
                            <p id="orderDate" class="mb-0">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Expected Delivery:</label>
                            <p id="expectedDeliveryDate" class="mb-0">-</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Status:</label>
                            <p id="poStatus" class="mb-0">-</p>
                                </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Total Amount:</label>
                            <p id="totalAmount" class="mb-0 fs-5 text-success fw-bold">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Total Items:</label>
                            <p id="totalItems" class="mb-0">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-muted">Created:</label>
                            <p id="createdDate" class="mb-0">-</p>
                        </div>
                    </div>
                    <div class="row mt-3" id="notesRow" style="display: none;">
                        <div class="col-12">
                            <label class="form-label fw-bold text-muted">Notes:</label>
                            <p id="notes" class="mb-0 border p-2 rounded bg-light">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                        <div class="col-md-3">
                            <h4 class="text-primary" id="itemTypesCount">0</h4>
                            <small class="text-muted">Item Types</small>
                    </div>
                        <div class="col-md-3">
                            <h4 class="text-success" id="totalQuantityCount">0</h4>
                            <small class="text-muted">Total Quantity</small>
                    </div>
                        <div class="col-md-3">
                            <h4 class="text-info" id="totalValueCount">Rp 0</h4>
                            <small class="text-muted">Total Value</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning" id="asnCount">0</h4>
                            <small class="text-muted">Related ASNs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Order Items -->
    <div class="row mb-4">
        <div class="col-12">
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>
                        Order Items (<span id="itemsCount">0</span>)
        </h5>
    </div>
    <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                            <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">#</th>
                                    <th style="width: 25%;">Item</th>
                                    <th style="width: 10%;" class="text-center">Unit</th>
                                    <th style="width: 15%;" class="text-end">Quantity</th>
                                    <th style="width: 20%;" class="text-end">Unit Price</th>
                                    <th style="width: 25%;" class="text-end">Total Price</th>
                        </tr>
                    </thead>
                            <tbody id="itemsBody">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading...
                                </td>
                            </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-active">
                                    <th colspan="5" class="text-end">Total:</th>
                            <th class="text-end">
                                        <span id="footerTotalAmount" class="fs-5 text-success fw-bold">Rp 0</span>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
                </div>
            </div>
        </div>
</div>

<!-- Related ASNs Section -->
    <div class="row" id="asnSection" style="display: none;">
        <div class="col-12">
            <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-truck me-2"></i>
                        Related ASNs (<span id="asnListCount">0</span>)
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                            <thead class="table-light">
                        <tr>
                            <th>ASN Number</th>
                            <th>Ship Date</th>
                            <th>Expected Arrival</th>
                                    <th>Actual Arrival</th>
                            <th>Status</th>
                                    <th>Total Items</th>
                                    <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                            <tbody id="asnListBody">
                    </tbody>
                </table>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
        const poId = @Model;

        document.addEventListener('DOMContentLoaded', function() {
            loadPODetails();
        });

        async function loadPODetails() {
            try {
                const response = await fetch(`/api/purchaseorder/${poId}`);
                const result = await response.json();

                if (result.success) {
                    populatePOInfo(result.data);
                    populateItemsTable(result.data.details);
                    updateSummaryStats(result.data);
                    await loadRelatedASNs(poId);
                } else {
                    showAlert('Error loading PO details: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error loading PO details:', error);
                showAlert('Error loading PO details', 'error');
            }
        }

        function populatePOInfo(data) {
            document.getElementById('poNumber').textContent = data.poNumber;
            document.getElementById('poNumberDisplay').textContent = data.poNumber;
            document.getElementById('supplierName').textContent = data.supplierName;
            document.getElementById('supplierEmail').textContent = data.supplierEmail || '-';
            document.getElementById('orderDate').textContent = data.orderDate ? new Date(data.orderDate).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '-';
            
            if (data.expectedDeliveryDate) {
                const deliveryDate = new Date(data.expectedDeliveryDate);
                const daysUntil = Math.ceil((deliveryDate - new Date()) / (1000 * 60 * 60 * 24));
                let deliveryHtml = deliveryDate.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                if (daysUntil < 0) {
                    deliveryHtml += `<br><small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${Math.abs(daysUntil)} days overdue</small>`;
                } else if (daysUntil <= 3) {
                    deliveryHtml += `<br><small class="text-warning"><i class="fas fa-clock me-1"></i>${daysUntil} days left</small>`;
                }
                document.getElementById('expectedDeliveryDate').innerHTML = deliveryHtml;
            } else {
                document.getElementById('expectedDeliveryDate').textContent = '-';
            }
            
            document.getElementById('totalAmount').textContent = formatCurrency(data.totalAmount);
            document.getElementById('totalItems').textContent = data.details?.length || 0;
            document.getElementById('createdDate').textContent = data.createdDate ? new Date(data.createdDate).toLocaleString('id-ID') : '-';
            
            const statusBadge = getStatusBadge(data.status);
            document.getElementById('poStatus').innerHTML = statusBadge;

            if (data.notes) {
                document.getElementById('notes').textContent = data.notes;
                document.getElementById('notesRow').style.display = 'block';
            }
        }

        function populateItemsTable(details) {
            const itemsBody = document.getElementById('itemsBody');
            itemsBody.innerHTML = '';

            if (!details || details.length === 0) {
                itemsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No items</td></tr>';
                document.getElementById('itemsCount').textContent = '0';
                return;
            }

            let totalAmount = 0;
            details.forEach((detail, index) => {
                const row = document.createElement('tr');
                totalAmount += detail.totalPrice;
                
                row.innerHTML = `
                    <td class="text-muted">${index + 1}</td>
                    <td>
                        <strong class="text-primary">${detail.itemCode}</strong><br>
                        <small class="text-muted">${detail.itemName}</small>
                        ${detail.notes ? `<br><small class="text-warning"><i class="fas fa-sticky-note me-1"></i>${detail.notes}</small>` : ''}
                    </td>
                    <td class="text-center">${detail.itemUnit}</td>
                    <td class="text-end">
                        <span class="badge bg-info">${detail.quantity.toLocaleString()}</span>
                    </td>
                    <td class="text-end">${formatCurrency(detail.unitPrice)}</td>
                    <td class="text-end">
                        <span class="fw-bold text-success">${formatCurrency(detail.totalPrice)}</span>
                    </td>
                `;
                itemsBody.appendChild(row);
            });

            document.getElementById('itemsCount').textContent = details.length;
            document.getElementById('footerTotalAmount').textContent = formatCurrency(totalAmount);
        }

        function updateSummaryStats(data) {
            const details = data.details || [];
            document.getElementById('itemTypesCount').textContent = details.length;
            
            const totalQuantity = details.reduce((sum, d) => sum + d.quantity, 0);
            document.getElementById('totalQuantityCount').textContent = totalQuantity.toLocaleString();
            
            document.getElementById('totalValueCount').textContent = formatCurrency(data.totalAmount);
        }

        async function loadRelatedASNs(poId) {
            try {
                // Get ASNs related to this PO - using the ASN list endpoint with filter
                const response = await fetch(`/api/asn?page=1&pageSize=100`);
                const result = await response.json();

                if (result.success && result.data) {
                    // Filter ASNs by purchaseOrderId
                    const relatedASNs = result.data.filter(asn => asn.purchaseOrderId === poId);
                    
                    if (relatedASNs.length > 0) {
                        populateASNsTable(relatedASNs);
                        document.getElementById('asnCount').textContent = relatedASNs.length;
                        document.getElementById('asnSection').style.display = 'block';
                    } else {
                        document.getElementById('asnCount').textContent = '0';
                        document.getElementById('asnSection').style.display = 'none';
                    }
                } else {
                    document.getElementById('asnCount').textContent = '0';
                    document.getElementById('asnSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading related ASNs:', error);
                document.getElementById('asnCount').textContent = '0';
            }
        }

        function populateASNsTable(asns) {
            const asnListBody = document.getElementById('asnListBody');
            asnListBody.innerHTML = '';

            asns.forEach(asn => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <a href="/ASN/Details/${asn.id}" class="text-primary text-decoration-none">
                            ${asn.asnNumber || 'N/A'}
                            <i class="fas fa-external-link-alt ms-1 small"></i>
                        </a>
                    </td>
                    <td>${asn.shipmentDate ? new Date(asn.shipmentDate).toLocaleDateString('id-ID') : '-'}</td>
                    <td>${asn.expectedArrivalDate ? new Date(asn.expectedArrivalDate).toLocaleDateString('id-ID') : '-'}</td>
                    <td>${asn.actualArrivalDate ? new Date(asn.actualArrivalDate).toLocaleDateString('id-ID') : '-'}</td>
                    <td>${getStatusBadge(asn.status)}</td>
                    <td>${asn.totalItems || 0}</td>
                    <td class="text-center">
                        <a href="/ASN/Details/${asn.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </td>
                `;
                asnListBody.appendChild(row);
            });

            document.getElementById('asnListCount').textContent = asns.length;
        }

        function getStatusBadge(status) {
            const badges = {
                'Draft': '<span class="badge bg-secondary">Draft</span>',
                'Sent': '<span class="badge bg-info">Sent</span>',
                'Received': '<span class="badge bg-success">Received</span>',
                'Cancelled': '<span class="badge bg-danger">Cancelled</span>',
                'Pending': '<span class="badge bg-secondary">Pending</span>',
                'On Delivery': '<span class="badge bg-warning">On Delivery</span>',
                'Arrived': '<span class="badge bg-success">Arrived</span>',
                'Processed': '<span class="badge bg-primary">Processed</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showAlert(message, type) {
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
}