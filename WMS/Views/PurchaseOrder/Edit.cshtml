@using WMS.Models.ViewModels
@model PurchaseOrderViewModel
@{
    ViewData["Title"] = "Edit Purchase Order";
}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">
                <i class="fas fa-edit me-2"></i>
                Edit Purchase Order
            </h1>
            <p class="page-subtitle">@Model.PONumber</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-outline-primary">
                    <i class="fas fa-eye"></i>
                    View Details
                </a>
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<form id="purchaseOrderForm" method="post" novalidate>
    <input asp-for="Id" type="hidden" />
    <input asp-for="PONumber" type="hidden" />

    <div class="row">
        <!-- Purchase Order Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Purchase Order Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">PO Number</label>
                                <input type="text" class="form-control" value="@Model.PONumber" readonly />
                                <div class="form-text">PO Number cannot be changed after creation</div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="SupplierId" class="form-label">Supplier <span class="text-danger">*</span></label>
                                <select asp-for="SupplierId" asp-items="Model.Suppliers" class="form-select">
                                    <option value="">-- Select Supplier --</option>
                                </select>
                                <span asp-validation-for="SupplierId" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="OrderDate" class="form-label">Order Date <span class="text-danger">*</span></label>
                                <input asp-for="OrderDate" type="date" class="form-control" />
                                <span asp-validation-for="OrderDate" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Current Status</label>
                                <div>
                                    @if (Model.Status == "Draft")
                                    {
                                        <span class="badge bg-secondary">@Model.Status</span>
                                        <div class="form-text text-success">This PO can be edited</div>
                                    }
                                    else
                                    {
                                        <span class="badge bg-primary">@Model.Status</span>
                                        <div class="form-text text-warning">Limited editing allowed</div>
                                    }
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="ExpectedDeliveryDate" class="form-label">Expected Delivery Date</label>
                                <input asp-for="ExpectedDeliveryDate" type="date" class="form-control" />
                                <span asp-validation-for="ExpectedDeliveryDate" class="text-danger small"></span>
                                <div class="form-text">When do you expect the goods to arrive?</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Total Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" class="form-control" id="totalAmount" value="@Model.TotalAmount.ToString("N0")" readonly />
                                </div>
                                <div class="form-text">Calculated automatically from items below</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="Notes" class="form-label">Notes</label>
                                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Any additional notes or special instructions..."></textarea>
                                <span asp-validation-for="Notes" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Order Items -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Order Items
                        </h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addItem()">
                            <i class="fas fa-plus"></i>
                            Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="itemsTable">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Item</th>
                                    <th style="width: 10%;">Unit</th>
                                    <th style="width: 15%;">Quantity</th>
                                    <th style="width: 15%;">Unit Price</th>
                                    <th style="width: 15%;">Total Price</th>
                                    <th style="width: 15%;">Notes</th>
                                    <th style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                @if (Model.Details != null && Model.Details.Any())
                                {
                                    @for (int i = 0; i < Model.Details.Count; i++)
                                    {
                                        <tr data-item-id="@Model.Details[i].ItemId">
                                            <td>
                                                <div class="fw-medium">@Model.Details[i].ItemCode - @Model.Details[i].ItemName</div>
                                                <input type="hidden" name="Details[@i].Id" value="@Model.Details[i].Id" />
                                                <input type="hidden" name="Details[@i].ItemId" value="@Model.Details[i].ItemId" />
                                            </td>
                                            <td>@Model.Details[i].ItemUnit</td>
                                            <td>
                                                <input type="number" name="Details[@i].Quantity" value="@Model.Details[i].Quantity"
                                                       class="form-control form-control-sm quantity-input" min="1" step="1"
                                                       data-index="@i" onchange="updateRowTotal(@i)" />
                                            </td>
                                            <td>
                                                <input type="number" name="Details[@i].UnitPrice" value="@Model.Details[i].UnitPrice"
                                                       class="form-control form-control-sm unitprice-input" min="0" step="0.01"
                                                       data-index="@i" onchange="updateRowTotal(@i)" />
                                            </td>
                                            <td>
                                                <span class="fw-medium text-success total-price" data-index="@i">
                                                    @Model.Details[i].TotalPrice.ToString("C0")
                                                </span>
                                                <input type="hidden" name="Details[@i].TotalPrice" value="@Model.Details[i].TotalPrice" class="totalprice-hidden" />
                                            </td>
                                            <td>
                                                <input type="text" name="Details[@i].Notes" value="@Model.Details[i].Notes"
                                                       class="form-control form-control-sm" placeholder="Notes..." />
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)" title="Remove Item">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <th colspan="4" class="text-end">Total:</th>
                                    <th id="grandTotal" class="text-success">@Model.TotalAmount.ToString("C0")</th>
                                    <th colspan="2"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="noItemsMessage" class="text-center py-5" style="display: @(Model.Details == null || !Model.Details.Any() ? "block" : "none")">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Items Added</h5>
                        <p class="text-muted">Click "Add Item" to start adding products to this purchase order.</p>
                        <button type="button" class="btn btn-primary" onclick="addItem()">
                            <i class="fas fa-plus me-1"></i>
                            Add Your First Item
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="h3 text-primary mb-1" id="itemCount">@(Model.Details?.Count ?? 0)</div>
                            <div class="small text-muted">Item Types</div>
                        </div>
                        <div class="col-6">
                            <div class="h3 text-success mb-1" id="totalQuantity">@(Model.Details?.Sum(d => d.Quantity) ?? 0)</div>
                            <div class="small text-muted">Total Qty</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span class="fw-bold" id="subtotalDisplay">@Model.TotalAmount.ToString("C0")</span>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total Amount:</span>
                        <span class="fw-bold text-success h5" id="totalDisplay">@Model.TotalAmount.ToString("C0")</span>
                    </div>

                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>All prices are in Indonesian Rupiah (IDR)</small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="saveButton">
                            <i class="fas fa-save"></i>
                            Update Purchase Order
                        </button>
                        <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                            Cancel Changes
                        </a>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Changes will be saved immediately upon submission.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Add Item to Purchase Order
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Select Item <span class="text-danger">*</span></label>
                                <select id="itemSelect" class="form-select">
                                    <option value="">-- Select Item --</option>
                                    @if (Model.Items != null)
                                    {
                                        @foreach (var item in Model.Items)
                                        {
                                            <option value="@item.Value"
                                                    data-unit="@item.GetType().GetProperty("Unit")?.GetValue(item, null)"
                                                    data-price="@item.GetType().GetProperty("StandardPrice")?.GetValue(item, null)">
                                                @item.Text
                                            </option>
                                        }
                                    }
                                </select>
                                <div class="invalid-feedback">Please select an item.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unit</label>
                                <input type="text" id="itemUnit" class="form-control" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" id="itemQuantity" class="form-control" min="1" step="1" />
                                <div class="invalid-feedback">Please enter a valid quantity.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unit Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="number" id="itemUnitPrice" class="form-control" min="0" step="0.01" />
                                </div>
                                <div class="invalid-feedback">Please enter a valid unit price.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Total Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" id="itemTotalPrice" class="form-control" readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea id="itemNotes" class="form-control" rows="2" placeholder="Any special notes for this item..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">
                    <i class="fas fa-plus"></i>
                    Add Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let nextIndex = @(Model.Details?.Count ?? 0);

        document.addEventListener('DOMContentLoaded', function() {
            // Update total when quantity or unit price changes in modal
            document.addEventListener('input', function(e) {
                if (e.target.id === 'itemQuantity' || e.target.id === 'itemUnitPrice') {
                    updateItemTotal();
                }
            });

            // Auto-fill unit and price when item is selected
            document.getElementById('itemSelect').addEventListener('change', function() {
                const selectedOption = this.selectedOptions[0];
                if (selectedOption && selectedOption.value) {
                    document.getElementById('itemUnit').value = selectedOption.getAttribute('data-unit') || '';
                    document.getElementById('itemUnitPrice').value = selectedOption.getAttribute('data-price') || '';
                    updateItemTotal();
                }
            });

            updateSummary();
        });

        function addItem() {
            // Reset form
            document.getElementById('itemForm').reset();
            document.getElementById('itemUnit').value = '';
            document.getElementById('itemTotalPrice').value = '';

            // Show modal
            new bootstrap.Modal(document.getElementById('addItemModal')).show();
        }

        function updateItemTotal() {
            const quantity = parseFloat(document.getElementById('itemQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('itemUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            document.getElementById('itemTotalPrice').value = formatCurrency(total);
        }

        function saveItem() {
            const itemSelect = document.getElementById('itemSelect');
            const quantity = document.getElementById('itemQuantity');
            const unitPrice = document.getElementById('itemUnitPrice');
            const notes = document.getElementById('itemNotes');

            // Validate
            let isValid = true;

            if (!itemSelect.value) {
                itemSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                itemSelect.classList.remove('is-invalid');
            }

            if (!quantity.value || quantity.value <= 0) {
                quantity.classList.add('is-invalid');
                isValid = false;
            } else {
                quantity.classList.remove('is-invalid');
            }

            if (!unitPrice.value || unitPrice.value <= 0) {
                unitPrice.classList.add('is-invalid');
                isValid = false;
            } else {
                unitPrice.classList.remove('is-invalid');
            }

            if (!isValid) return;

            // Check for duplicate items
            const existingRow = document.querySelector(`tr[data-item-id="${itemSelect.value}"]`);
            if (existingRow) {
                alert('This item is already added to the purchase order.');
                return;
            }

            // Add new row to table
            const tbody = document.getElementById('itemsTableBody');
            const itemText = itemSelect.selectedOptions[0].text;
            const unit = document.getElementById('itemUnit').value;
            const qty = parseInt(quantity.value);
            const price = parseFloat(unitPrice.value);
            const total = qty * price;

            const newRow = document.createElement('tr');
            newRow.setAttribute('data-item-id', itemSelect.value);
            newRow.innerHTML = `
                <td>
                    <div class="fw-medium">${itemText}</div>
                    <input type="hidden" name="Details[${nextIndex}].ItemId" value="${itemSelect.value}" />
                </td>
                <td>${unit}</td>
                <td>
                    <input type="number" name="Details[${nextIndex}].Quantity" value="${qty}"
                           class="form-control form-control-sm quantity-input" min="1" step="1"
                           data-index="${nextIndex}" onchange="updateRowTotal(${nextIndex})" />
                </td>
                <td>
                    <input type="number" name="Details[${nextIndex}].UnitPrice" value="${price}"
                           class="form-control form-control-sm unitprice-input" min="0" step="0.01"
                           data-index="${nextIndex}" onchange="updateRowTotal(${nextIndex})" />
                </td>
                <td>
                    <span class="fw-medium text-success total-price" data-index="${nextIndex}">
                        ${formatCurrency(total)}
                    </span>
                    <input type="hidden" name="Details[${nextIndex}].TotalPrice" value="${total}" class="totalprice-hidden" />
                </td>
                <td>
                    <input type="text" name="Details[${nextIndex}].Notes" value="${notes.value}"
                           class="form-control form-control-sm" placeholder="Notes..." />
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)" title="Remove Item">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(newRow);
            nextIndex++;

            updateDisplayAfterChange();

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
        }

        function removeRow(button) {
            if (confirm('Are you sure you want to remove this item?')) {
                button.closest('tr').remove();
                updateDisplayAfterChange();
            }
        }

        function updateRowTotal(index) {
            const row = document.querySelector(`tr:has(input[data-index="${index}"])`);
            if (!row) return;

            const qtyInput = row.querySelector(`.quantity-input[data-index="${index}"]`);
            const priceInput = row.querySelector(`.unitprice-input[data-index="${index}"]`);
            const totalSpan = row.querySelector(`.total-price[data-index="${index}"]`);
            const totalHidden = row.querySelector('input[name*="TotalPrice"]');

            if (qtyInput && priceInput && totalSpan && totalHidden) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = qty * price;

                totalSpan.textContent = formatCurrency(total);
                totalHidden.value = total;

                updateSummary();
            }
        }

        function updateDisplayAfterChange() {
            const tbody = document.getElementById('itemsTableBody');
            const noItemsMessage = document.getElementById('noItemsMessage');
            const table = document.getElementById('itemsTable');

            if (tbody.children.length === 0) {
                noItemsMessage.style.display = 'block';
                table.style.display = 'none';
            } else {
                noItemsMessage.style.display = 'none';
                table.style.display = 'table';
            }

            updateSummary();
        }

        function updateSummary() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let totalAmount = 0;
            let totalQuantity = 0;
            let itemCount = rows.length;

            rows.forEach(row => {
                const qtyInput = row.querySelector('.quantity-input');
                const totalHidden = row.querySelector('input[name*="TotalPrice"]');

                if (qtyInput && totalHidden) {
                    totalQuantity += parseInt(qtyInput.value) || 0;
                    totalAmount += parseFloat(totalHidden.value) || 0;
                }
            });

            // Update displays
            document.getElementById('itemCount').textContent = itemCount;
            document.getElementById('totalQuantity').textContent = formatNumber(totalQuantity);
            document.getElementById('grandTotal').textContent = formatCurrency(totalAmount);
            document.getElementById('totalAmount').value = formatNumber(totalAmount);
            document.getElementById('subtotalDisplay').textContent = formatCurrency(totalAmount);
            document.getElementById('totalDisplay').textContent = formatCurrency(totalAmount);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('id-ID').format(number);
        }

        // Form submission
        document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            if (rows.length === 0) {
                e.preventDefault();
                alert('Please add at least one item to the purchase order.');
                return;
            }

            // Show loading state
            const submitBtn = document.getElementById('saveButton');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';

            // Re-enable if there's an error (will be handled by page reload)
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 5000);
        });
    </script>
}