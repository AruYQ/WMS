@using WMS.Models.ViewModels
@model PurchaseOrderViewModel
@{
    ViewData["Title"] = "Create Purchase Order";
}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">
                <i class="fas fa-plus-circle me-2"></i>
                Create Purchase Order
            </h1>
            <p class="page-subtitle">Create a new purchase order to send to suppliers</p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to List
            </a>
        </div>
    </div>
</div>

<form id="purchaseOrderForm" method="post" novalidate>
    <input asp-for="Id" type="hidden" />

    <div class="row">
        <!-- Purchase Order Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Purchase Order Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="SupplierId" class="form-label">Supplier <span class="text-danger">*</span></label>
                                <select asp-for="SupplierId" asp-items="Model.Suppliers" class="form-select">
                                    <option value="">-- Select Supplier --</option>
                                </select>
                                <span asp-validation-for="SupplierId" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="OrderDate" class="form-label">Order Date <span class="text-danger">*</span></label>
                                <input asp-for="OrderDate" type="date" class="form-control" />
                                <span asp-validation-for="OrderDate" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ExpectedDeliveryDate" class="form-label">Expected Delivery Date</label>
                                <input asp-for="ExpectedDeliveryDate" type="date" class="form-control" />
                                <span asp-validation-for="ExpectedDeliveryDate" class="text-danger small"></span>
                                <div class="form-text">When do you expect the goods to arrive?</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Total Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" class="form-control" id="totalAmount" value="0" readonly />
                                </div>
                                <div class="form-text">Calculated automatically from items below</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="Notes" class="form-label">Notes</label>
                                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Any additional notes or special instructions..."></textarea>
                                <span asp-validation-for="Notes" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Order Items -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Order Items
                        </h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addItem()">
                            <i class="fas fa-plus"></i>
                            Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="itemsTable">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Item</th>
                                    <th style="width: 10%;">Unit</th>
                                    <th style="width: 15%;">Quantity</th>
                                    <th style="width: 15%;">Unit Price</th>
                                    <th style="width: 15%;">Total Price</th>
                                    <th style="width: 15%;">Notes</th>
                                    <th style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically here -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <th colspan="4" class="text-end">Total:</th>
                                    <th id="grandTotal" class="text-success">Rp 0</th>
                                    <th colspan="2"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="noItemsMessage" class="text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Items Added</h5>
                        <p class="text-muted">Click "Add Item" to start adding products to this purchase order.</p>
                        <button type="button" class="btn btn-primary" onclick="addItem()">
                            <i class="fas fa-plus me-1"></i>
                            Add Your First Item
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="h3 text-primary mb-1" id="itemCount">0</div>
                            <div class="small text-muted">Item Types</div>
                        </div>
                        <div class="col-6">
                            <div class="h3 text-success mb-1" id="totalQuantity">0</div>
                            <div class="small text-muted">Total Qty</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span class="fw-bold" id="subtotalDisplay">Rp 0</span>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total Amount:</span>
                        <span class="fw-bold text-success h5" id="totalDisplay">Rp 0</span>
                    </div>

                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>All prices are in Indonesian Rupiah (IDR)</small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="saveButton">
                            <i class="fas fa-save"></i>
                            Create Purchase Order
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-eraser"></i>
                            Clear Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Add Item to Purchase Order
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Select Item <span class="text-danger">*</span></label>
                                <select id="itemSelect" class="form-select">
                                    <option value="">-- Select Item --</option>
                                    @if (Model.Items != null)
                                    {
                                        @foreach (var item in Model.Items)
                                        {
                                            <option value="@item.Value"
                                                    data-unit="@item.GetType().GetProperty("Unit")?.GetValue(item, null)"
                                                    data-price="@item.GetType().GetProperty("StandardPrice")?.GetValue(item, null)">
                                                @item.Text
                                            </option>
                                        }
                                    }
                                </select>
                                <div class="invalid-feedback">Please select an item.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unit</label>
                                <input type="text" id="itemUnit" class="form-control" value="" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" id="itemQuantity" class="form-control" min="1" step="1" />
                                <div class="invalid-feedback">Please enter a valid quantity.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unit Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="number" id="itemUnitPrice" class="form-control" min="0" step="0.01" />
                                </div>
                                <div class="invalid-feedback">Please enter a valid unit price.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Total Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" id="itemTotalPrice" class="form-control" readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea id="itemNotes" class="form-control" rows="2" placeholder="Any special notes for this item..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">
                    <i class="fas fa-plus"></i>
                    Add Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let itemIndex = 0;
        let items = [];

        // Get items data from ViewBag
        const itemsData = @Html.Raw(Json.Serialize(ViewBag.ItemsData ?? new { }));

        document.addEventListener('DOMContentLoaded', function() {
            // Update total when quantity or unit price changes
            document.addEventListener('input', function(e) {
                if (e.target.id === 'itemQuantity' || e.target.id === 'itemUnitPrice') {
                    updateItemTotal();
                }
            });

            // Auto-fill unit and price when item is selected
            document.getElementById('itemSelect').addEventListener('change', function() {
                const selectedValue = this.value;

                if (selectedValue && itemsData[selectedValue]) {
                    const itemData = itemsData[selectedValue];

                    // Update the unit field
                    document.getElementById('itemUnit').value = itemData.unit || '';

                    // Update the unit price field with standard price
                    document.getElementById('itemUnitPrice').value = itemData.standardPrice || '';

                    // Recalculate total
                    updateItemTotal();

                    console.log('Selected Item:', itemData.name);
                    console.log('Unit:', itemData.unit);
                    console.log('Standard Price:', itemData.standardPrice);
                } else {
                    // Clear fields if no item selected
                    document.getElementById('itemUnit').value = '';
                    document.getElementById('itemUnitPrice').value = '';
                    document.getElementById('itemTotalPrice').value = '';
                }
            });

            updateDisplay();
        });

        // Keep all your existing functions (addItem, updateItemTotal, saveItem, etc.) - don't change them
        function addItem() {
            document.getElementById('itemForm').reset();
            document.getElementById('itemUnit').value = '';
            document.getElementById('itemTotalPrice').value = '';
            new bootstrap.Modal(document.getElementById('addItemModal')).show();
        }

        function updateItemTotal() {
            const quantity = parseFloat(document.getElementById('itemQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('itemUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            document.getElementById('itemTotalPrice').value = formatCurrency(total);
        }

        function saveItem() {
            const itemSelect = document.getElementById('itemSelect');
            const quantity = document.getElementById('itemQuantity');
            const unitPrice = document.getElementById('itemUnitPrice');
            const notes = document.getElementById('itemNotes');

            let isValid = true;

            if (!itemSelect.value) {
                itemSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                itemSelect.classList.remove('is-invalid');
            }

            if (!quantity.value || quantity.value <= 0) {
                quantity.classList.add('is-invalid');
                isValid = false;
            } else {
                quantity.classList.remove('is-invalid');
            }

            if (!unitPrice.value || unitPrice.value <= 0) {
                unitPrice.classList.add('is-invalid');
                isValid = false;
            } else {
                unitPrice.classList.remove('is-invalid');
            }

            if (!isValid) return;

            const existingItem = items.find(item => item.itemId === parseInt(itemSelect.value));
            if (existingItem) {
                alert('This item is already added to the purchase order.');
                return;
            }

            const item = {
                id: itemIndex++,
                itemId: parseInt(itemSelect.value),
                itemText: itemSelect.selectedOptions[0].text,
                unit: document.getElementById('itemUnit').value,
                quantity: parseInt(quantity.value),
                unitPrice: parseFloat(unitPrice.value),
                totalPrice: parseInt(quantity.value) * parseFloat(unitPrice.value),
                notes: notes.value
            };

            items.push(item);
            updateDisplay();
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
        }

        function removeItem(id) {
            if (confirm('Are you sure you want to remove this item?')) {
                items = items.filter(item => item.id !== id);
                updateDisplay();
            }
        }

        function updateDisplay() {
            const tbody = document.getElementById('itemsTableBody');
            const noItemsMessage = document.getElementById('noItemsMessage');

            if (items.length === 0) {
                tbody.innerHTML = '';
                noItemsMessage.style.display = 'block';
                document.querySelector('#itemsTable').style.display = 'none';
            } else {
                noItemsMessage.style.display = 'none';
                document.querySelector('#itemsTable').style.display = 'table';

                tbody.innerHTML = items.map(item => `
                    <tr>
                        <td>
                            <div class="fw-medium">${escapeHtml(item.itemText)}</div>
                            <input type="hidden" name="Details[${item.id}].ItemId" value="${item.itemId}" />
                        </td>
                        <td>${escapeHtml(item.unit)}</td>
                        <td>
                            ${formatNumber(item.quantity)}
                            <input type="hidden" name="Details[${item.id}].Quantity" value="${item.quantity}" />
                        </td>
                        <td>
                            ${formatCurrency(item.unitPrice)}
                            <input type="hidden" name="Details[${item.id}].UnitPrice" value="${item.unitPrice}" />
                        </td>
                        <td class="fw-medium text-success">
                            ${formatCurrency(item.totalPrice)}
                            <input type="hidden" name="Details[${item.id}].TotalPrice" value="${item.totalPrice}" />
                        </td>
                        <td>
                            ${escapeHtml(item.notes) || '-'}
                            <input type="hidden" name="Details[${item.id}].Notes" value="${escapeHtml(item.notes)}" />
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})" title="Remove Item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            const totalAmount = items.reduce((sum, item) => sum + item.totalPrice, 0);
            const totalQuantity = items.reduce((sum, item) => sum + item.quantity, 0);

            document.getElementById('itemCount').textContent = items.length;
            document.getElementById('totalQuantity').textContent = formatNumber(totalQuantity);
            document.getElementById('grandTotal').textContent = formatCurrency(totalAmount);
            document.getElementById('totalAmount').value = formatCurrency(totalAmount);
            document.getElementById('subtotalDisplay').textContent = formatCurrency(totalAmount);
            document.getElementById('totalDisplay').textContent = formatCurrency(totalAmount);
            document.getElementById('saveButton').disabled = items.length === 0;
        }

        function clearForm() {
            if (confirm('Are you sure you want to clear the form? All data will be lost.')) {
                document.getElementById('purchaseOrderForm').reset();
                items = [];
                itemIndex = 0;
                updateDisplay();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('id-ID').format(number);
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
            if (items.length === 0) {
                e.preventDefault();
                alert('Please add at least one item to the purchase order.');
                return;
            }

            const submitBtn = document.getElementById('saveButton');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 5000);
        });
    </script>
}