@*
    Advanced Search Modal khusus untuk Supplier dalam konteks Purchase Order
    Menggunakan metode AJAX JavaScript
*@

<div class="modal fade" id="purchaseOrderSupplierAdvancedSearchModal" tabindex="-1" aria-labelledby="purchaseOrderSupplierAdvancedSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchaseOrderSupplierAdvancedSearchModalLabel">
                    <i class="fas fa-search me-2"></i>
                    Advanced Search - Supplier
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search Form -->
                <form id="purchaseOrderSupplierSearchForm">
                    <div class="row">
                        <!-- Quick Search -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierSearchText" class="form-label">
                                <i class="fas fa-font me-1"></i>
                                Quick Search
                            </label>
                            <input type="text" class="form-control" id="supplierSearchText" placeholder="Search supplier name, code, or email...">
                            <div class="form-text">Search in name, code, or email fields</div>
                        </div>

                        <!-- Supplier Name -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierNameFilter" class="form-label">
                                <i class="fas fa-building me-1"></i>
                                Supplier Name
                            </label>
                            <input type="text" class="form-control" id="supplierNameFilter" placeholder="Filter by supplier name...">
                        </div>

                        <!-- Supplier Code -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierCodeFilter" class="form-label">
                                <i class="fas fa-code me-1"></i>
                                Supplier Code
                            </label>
                            <input type="text" class="form-control" id="supplierCodeFilter" placeholder="Filter by supplier code...">
                        </div>

                        <!-- Phone -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierPhoneFilter" class="form-label">
                                <i class="fas fa-phone me-1"></i>
                                Phone
                            </label>
                            <input type="text" class="form-control" id="supplierPhoneFilter" placeholder="Filter by phone...">
                        </div>

                        <!-- City -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierCityFilter" class="form-label">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                City
                            </label>
                            <input type="text" class="form-control" id="supplierCityFilter" placeholder="Filter by city...">
                        </div>

                        <!-- Status -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierStatusFilter" class="form-label">
                                <i class="fas fa-toggle-on me-1"></i>
                                Status
                            </label>
                            <select class="form-select" id="supplierStatusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" id="searchSuppliersBtn">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" id="clearSupplierSearchBtn">
                                <i class="fas fa-times me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </form>

                <hr>

                <!-- Search Results -->
                <div id="supplierSearchResults">
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>Enter search criteria and click Search to find suppliers</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentSupplierCallback = null;
    let currentSupplierConfig = null;

    // Expose function to open supplier advanced search
    window.openPurchaseOrderSupplierAdvancedSearch = function(callback, config = {}) {
        currentSupplierCallback = callback;
        currentSupplierConfig = config;
        
        // Clear form
        document.getElementById('purchaseOrderSupplierSearchForm').reset();
        document.getElementById('supplierSearchResults').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-search fa-2x mb-3"></i>
                <p>Enter search criteria and click Search to find suppliers</p>
            </div>
        `;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('purchaseOrderSupplierAdvancedSearchModal'));
        modal.show();
    };

    // Search button click
    document.getElementById('searchSuppliersBtn').addEventListener('click', function() {
        searchSuppliers();
    });

    // Clear button click
    document.getElementById('clearSupplierSearchBtn').addEventListener('click', function() {
        document.getElementById('purchaseOrderSupplierSearchForm').reset();
        document.getElementById('supplierSearchResults').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-search fa-2x mb-3"></i>
                <p>Enter search criteria and click Search to find suppliers</p>
            </div>
        `;
    });

    // Enter key in search text
    document.getElementById('supplierSearchText').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchSuppliers();
        }
    });

    // Search suppliers function
    async function searchSuppliers() {
        const searchText = document.getElementById('supplierSearchText').value;
        const nameFilter = document.getElementById('supplierNameFilter').value;
        const codeFilter = document.getElementById('supplierCodeFilter').value;
        const phoneFilter = document.getElementById('supplierPhoneFilter').value;
        const cityFilter = document.getElementById('supplierCityFilter').value;
        const statusFilter = document.getElementById('supplierStatusFilter').value;

        // Show loading
        document.getElementById('supplierSearchResults').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Searching suppliers...</p>
            </div>
        `;

        try {
            const requestData = {
                SearchText: searchText,
                SupplierNameFilter: nameFilter,
                SupplierCodeFilter: codeFilter,
                PhoneFilter: phoneFilter,
                CityFilter: cityFilter,
                StatusFilter: statusFilter,
                Page: 1,
                PageSize: 50
            };

            const response = await fetch('/api/purchaseorder/suppliers/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.success) {
                displaySupplierResults(result.data);
            } else {
                document.getElementById('supplierSearchResults').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error: ${result.message}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error searching suppliers:', error);
            document.getElementById('supplierSearchResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error searching suppliers. Please try again.
                </div>
            `;
        }
    }

    // Display supplier results
    function displaySupplierResults(suppliers) {
        const resultsContainer = document.getElementById('supplierSearchResults');
        
        if (!suppliers || suppliers.length === 0) {
            resultsContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>No suppliers found matching your criteria</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Search Results (${suppliers.length} suppliers found)
                </h6>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Code</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>City</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        suppliers.forEach(supplier => {
            const statusBadge = supplier.isActive ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-secondary">Inactive</span>';

            html += `
                <tr class="supplier-row" data-supplier-id="${supplier.id}">
                    <td>
                        <strong>${supplier.name}</strong>
                    </td>
                    <td>${supplier.code || 'N/A'}</td>
                    <td>${supplier.email || 'N/A'}</td>
                    <td>${supplier.phone || 'N/A'}</td>
                    <td>${supplier.city || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary select-supplier-btn" 
                                data-supplier='${JSON.stringify(supplier)}'>
                            <i class="fas fa-check me-1"></i>Select
                        </button>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        resultsContainer.innerHTML = html;

        // Add click handlers for select buttons
        document.querySelectorAll('.select-supplier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const supplierData = JSON.parse(this.getAttribute('data-supplier'));
                selectSupplier(supplierData);
            });
        });
    }

    // Select supplier function
    function selectSupplier(supplier) {
        if (currentSupplierCallback) {
            currentSupplierCallback(supplier);
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseOrderSupplierAdvancedSearchModal'));
        modal.hide();
    }
});
</script>
